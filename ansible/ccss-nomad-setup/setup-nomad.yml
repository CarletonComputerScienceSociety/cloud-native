---
- hosts: servers
  remote_user: student
  become: true
  tasks:
    - name: Update apt repo and cache on all Debian/Ubuntu boxes
      apt: update_cache=yes force_apt_get=yes cache_valid_time=3600

    - name: Upgrade all packages on servers
      apt: upgrade=dist force_apt_get=yes

    - name: Check if a reboot is needed on all servers
      register: reboot_required_file
      stat: path=/var/run/reboot-required get_md5=no

    - name: Reboot the box if kernel updated
      reboot:
        msg: "Reboot initiated by Ansible for kernel updates"
        connect_timeout: 5
        reboot_timeout: 300
        pre_reboot_delay: 0
        post_reboot_delay: 30
        test_command: uptime
      when: reboot_required_file.stat.exists

- hosts: servers
  remote_user: student
  become: true
  tasks:
  - name: Check sizes
    command: df /
    register: df

  - debug: msg="{{ df.stdout }}"

- hosts: servers
  remote_user: student
  become: true
  tasks:
  - name: Expand partition
    command: /home/student/extend-lvm/extend-lvm.sh /dev/vda

- hosts: servers
  remote_user: student
  become: true
  tasks:
  - name: Check sizes
    command: df /
    register: df

  - debug: msg="{{ df.stdout }}"

- name: Install Docker
  hosts: servers
  become: yes
  remote_user: student
  roles:
    - role: geerlingguy.docker

- name: Install HashiStack
  hosts: servers
  become: yes
  remote_user: student
  tasks:
    - name: Add repo
      shell: |
        curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
        apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"

    - name: Update apt repo and cache on all Debian/Ubuntu boxes
      apt: update_cache=yes force_apt_get=yes cache_valid_time=3600

    - name: Install Nomad
      apt: name=nomad state=present

    - name: Install Consul
      apt: name=consul state=present

- name: Installing Nomad Consul Connect
  hosts: servers
  remote_user: student
  become: true
  tasks:
  - name: Download Consul Connect plugin
    shell: |
      curl -L -o cni-plugins.tgz https://github.com/containernetworking/plugins/releases/download/v0.9.1/cni-plugins-linux-amd64-v0.9.1.tgz;
      mkdir -p /opt/cni/bin;
      tar -C /opt/cni/bin -xzf cni-plugins.tgz;
      echo 1 > /proc/sys/net/bridge/bridge-nf-call-arptables;
      echo 1 > /proc/sys/net/bridge/bridge-nf-call-ip6tables;
      echo 1 > /proc/sys/net/bridge/bridge-nf-call-iptables;
      echo net.bridge.bridge-nf-call-arptables = 1 > /etc/sysctl.d/10-nomad-consul-connect.conf;
      echo net.bridge.bridge-nf-call-ip6tables = 1 >> /etc/sysctl.d/10-nomad-consul-connect.conf;
      echo net.bridge.bridge-nf-call-iptables = 1 >> /etc/sysctl.d/10-nomad-consul-connect.conf;

- name: Add ssh keys
  hosts: servers
  remote_user: student
  become: true
  tasks:
  - name: Download ssh keys
    shell: |
      curl https://github.com/angelonfira.keys > ~/.ssh/authorized_keys

  - name: Disable root login over SSH
    lineinfile: dest=/etc/ssh/sshd_config regexp="^PermitRootLogin" line="PermitRootLogin no" state=present
    notify:
      - restart sshd

  - name: Disable password login
    lineinfile: dest=/etc/ssh/sshd_config regexp="^PasswordAuthentication" line="PasswordAuthentication no" state=present
    notify:
      - restart sshd

# - hosts: all
#   remote_user: student
#   become: true
  
#   tasks:
#     - name: Change user password
#       user:
#         name: student
#         update_password: always
#         password: "{{ 'newpassword'|password_hash('sha512') }}"